name: Clear GitHub Actions Cache

# Manual trigger only
on:
  workflow_dispatch:

jobs:
  clear-cache:
    name: Clear Cache
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Get cache list via REST API
        id: fetch-caches
        run: |
          echo "ðŸ—‘ï¸  Fetching all GitHub Actions caches via REST API..."

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches")

          TOTAL=$(echo "$RESPONSE" | jq '.total_count')
          echo "Found $TOTAL cache entries"
          echo "caches_json=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Delete all caches via REST API
        if: fromJson(steps.fetch-caches.outputs.caches_json).total_count > 0
        run: |
          echo "Deleting all caches..."

          CACHES='${{ steps.fetch-caches.outputs.caches_json }}'

          echo "$CACHES" | jq -r '.actions_caches[] | .key' | while read CACHE_KEY; do
            if [ ! -z "$CACHE_KEY" ]; then
              echo "  â†’ Deleting cache: $CACHE_KEY"
              
              curl -s -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/actions/caches?key=$CACHE_KEY" \
                | jq -r '.total_count // "deleted"' || true
            fi
          done

          echo "âœ… Cache deletion completed!"

      - name: Verify cache cleared
        run: |
          echo "ðŸ“Š Verifying cache status..."

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches")

          REMAINING=$(echo "$RESPONSE" | jq '.total_count')
          echo "Remaining caches: $REMAINING"

          if [ "$REMAINING" -gt 0 ]; then
            echo ""
            echo "Sample of remaining caches (first 5):"
            echo "$RESPONSE" | jq '.actions_caches[] | {key: .key, size_bytes: .size_in_bytes, created_at: .created_at}' | head -30
          else
            echo "âœ… All caches successfully cleared!"
          fi
