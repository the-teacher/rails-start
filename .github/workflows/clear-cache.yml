name: Clear GitHub Actions Cache

# Manual trigger only
on:
  workflow_dispatch:

jobs:
  clear-cache:
    name: Clear Cache
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Get cache list via REST API
        id: fetch-caches
        run: |
          echo "üóëÔ∏è  Fetching all GitHub Actions caches via REST API..."

          curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches" \
            > /tmp/caches.json

          TOTAL=$(jq '.total_count' /tmp/caches.json)
          echo "Found $TOTAL cache entries"
          echo "cache_count=$TOTAL" >> $GITHUB_OUTPUT

      - name: Delete all caches via REST API
        if: steps.fetch-caches.outputs.cache_count > 0
        run: |
          echo "üóëÔ∏è  Deleting all ${{ steps.fetch-caches.outputs.cache_count }} caches..."

          DELETED=0
          jq -r '.actions_caches[] | .key' /tmp/caches.json | while read CACHE_KEY; do
            if [ ! -z "$CACHE_KEY" ]; then
              echo "  ‚Üí Deleting: $CACHE_KEY"
              
              curl -s -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/actions/caches?key=$CACHE_KEY"
              
              DELETED=$((DELETED + 1))
            fi
          done

          echo "‚úÖ Deletion completed!"

      - name: Verify cache cleared
        run: |
          echo "üìä Verifying cache status..."

          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches")

          REMAINING=$(echo "$RESPONSE" | jq '.total_count')
          echo "Remaining caches: $REMAINING"

          if [ "$REMAINING" -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Sample of remaining caches (first 5):"
            echo "$RESPONSE" | jq '.actions_caches[] | {key: .key, size_bytes: .size_in_bytes, created_at: .created_at}' | head -30
          else
            echo "‚úÖ All caches successfully cleared!"
          fi
